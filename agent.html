<html>

<head>
  <link href="bundle.css" rel="stylesheet" />
  <style>
    /* position alerts at the bottom of the page */
    .alert {
      position: fixed;
      bottom: 0;
      left: 1em;
      width: calc(100% - 2em);
    }

    #loading {
      height: calc(100% - 3em);
    }

    #options {
      margin-bottom: 2em;
    }

    #title,
    #description {
      display: none;
    }

    @font-face {
      font-family: "FusionPixel";
      src: url("assets/fusion-pixel-10px-monospaced-latin-min.woff2");
      font-weight: normal;
      font-style: normal;
    }

    * {
      font-family: "FusionPixel" !important;
      text-rendering: geometricPrecision;
      cursor: url("assets/kmtt-cursor-handmin-hyper.svg") 4 2, auto;
    }

    input[type="checkbox"]:hover {
      cursor: url("assets/kmtt-cursor-hover-handmin.svg") 8 2, pointer;
    }

    :root {
      /* --splash-stripe-color1: #f4c094; */
      /* --splash-stripe-color2: #ecad84; */
      --splash-stripe-color1: #cb8a70;
      --splash-stripe-color2: #c67c63;
      --splash-animation-duration: 1.3s;
      --splash-animation-delay: 1.8s;
      --splash-max-width: 800px;
      --splash-width: min(100vw, var(--splash-max-width));
      --splash-stripe-width: calc(var(--splash-width) * 0.03);
      --background-color: #ffdbb5;
      --primary-stripe-rgb: #f7cba5;
      --secondary-stripe-rgb: rgba(47, 0, 255, 0);
      --stripe-point1: 25.5%;
      --stripe-point2: calc(100% - var(--stripe-point1));
      --stripe-angle1: 60deg;
      --stripe-angle2: calc(-1 * var(--stripe-angle1));

      --box-primary-color: #efb78e;
      --box-secondary-color: #f4bf94;
      --box-dashed: #c07e65;
      --box-background: #ffe3a5;
      --box-border: #bd7d63;
      --box-very-out: #ac7e62;

      --wood-plank-width: calc(100% / 12);
      --wood-plank-side-width: calc(var(--wood-plank-width) / 2);
      --wood-plank-top-width: 6px;
      --wood-plank-bottom-width: 16px;

      --wood-color-dark: #8c4e44;
      --wood-color-light: #a7654f;

      --wood-inset-dark: rgba(42, 0, 0, 0.325);
      --wood-inset-light: #d6997b6c;
      --wood-inset-length: 2px;

      --wood-grain: rgba(80, 26, 1, 0.11);
      --wood-grain-minor: rgba(80, 26, 1, 0.09);

      --wood-edge-color: #70353c;

      --wood-border-color: #d6997b;

      --paper-color: #fff3c6;
      --paper-color-dark: #fdebbd;
      --paper-border-color: #f4c389;
      --paper-border-width: 8px;
      --paper-shadow-size: 70%;

      --checkbox-corner-color: #e7aa84;
      --checkbox-border-color: #c07f65;
      --checkbox-border-bottom-color: var(--wood-color-light);
      --checkbox-inner-color: #f4c094;

      --label-font-color: #71363d;

      font-size: 120%;
    }

    :root::after,
    :root::before,
    body::after,
    .container::after,
    .container::before {
      content: "";
      position: fixed;
      pointer-events: none;
      image-rendering: pixelated;
      inset: 0;
    }

    /* curtain, floor */
    :root::after {
      z-index: 4;
      background:
        repeat-x top/min(calc(var(--splash-width) * 0.12), 12vh) url("assets/kmtt-new-day-curtain-min.webp"),
        repeat-x bottom/min(calc(var(--splash-width) * 0.16), 16vh) url("assets/kmtt-new-day-floor.webp");
      animation: splash-foreground-exit var(--splash-animation-duration) ease var(--splash-animation-delay) forwards;
    }

    /* characters */
    .container::before {
      z-index: 5;
      content: "";
      background: no-repeat bottom/min(var(--splash-width), 80vh) url("assets/kmtt-new-day-characters-min.webp");
      animation: characters-slide-up 0.4s ease-out 0.3s both, splash-foreground-exit var(--splash-animation-duration) ease var(--splash-animation-delay) forwards;
    }

    /* logo */
    .container::after {
      z-index: 3;
      background: no-repeat 50% 17%/min(calc(var(--splash-width) * 0.7), 70vh) url("assets/kmtt-logo-divided-min.webp");
      opacity: 0;
      animation: spotlight-fade-in 0.2s ease-in-out forwards 0.1s, splash-foreground-exit var(--splash-animation-duration) ease var(--splash-animation-delay) forwards;
    }

    /* spotlight */
    body::after {
      z-index: 2;
      background: no-repeat center/max(100vw, 100vh) url("assets/kmtt-new-day-spotlight-min.webp");
      mix-blend-mode: color-dodge;
      opacity: 0;
      animation: spotlight-fade-in 0.2s ease-in-out forwards 0.1s, splash-foreground-exit var(--splash-animation-duration) ease var(--splash-animation-delay) forwards;
    }

    /* striped background, lit by spotlight */
    :root::before {
      z-index: 1;
      background: repeating-linear-gradient(to right, var(--splash-stripe-color1), var(--splash-stripe-color1) var(--splash-stripe-width), var(--splash-stripe-color2) var(--splash-stripe-width), var(--splash-stripe-color2) calc(var(--splash-stripe-width) * 2));
      animation: splash-background-exit var(--splash-animation-duration) ease var(--splash-animation-delay) forwards;
    }

    @keyframes characters-slide-up {
      from {
        transform: translate3d(0, 100vh, 0);
      }

      to {
        transform: translate3d(0, 0, 0);
      }
    }

    @keyframes spotlight-fade-in {
      to {
        opacity: 1;
      }
    }

    @keyframes splash-foreground-exit {
      0% {
        filter: brightness(1);
        opacity: 1;
      }

      50% {
        filter: brightness(0);
        opacity: 1;
      }

      51%,
      100% {
        filter: brightness(0);
        opacity: 0;
        visibility: hidden;
      }
    }

    @keyframes splash-background-exit {
      0% {
        filter: brightness(1);
        opacity: 1;
      }

      50% {
        filter: brightness(0);
        opacity: 1;
      }

      95%,
      100% {
        filter: brightness(0);
        opacity: 0;
        visibility: hidden;
      }
    }

    /* diamond checkers */
    body::before {
      content: "";
      position: fixed;
      top: -76px;
      left: -88px;
      width: calc(100% + 88px);
      height: calc(100% + 76px);
      z-index: -1;
      background-image: url("assets/kmtt-background-pattern-min.webp");
      animation: pan 3s linear reverse infinite;
    }

    @keyframes pan {
      from {
        transform: translate3d(0, 0, 0);
      }

      to {
        /* image is 44x76, move twice the width */
        transform: translate3d(88px, 76px, 0px);
      }
    }

    /* #options::before {
      font-size: 200%;
      content: "Settings";
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translate(-50%, 0);
    } */

    /* wood board */
    #options {
      z-index: 0;
      position: relative;
      background-image:
        /* insets */
        linear-gradient(to right,
          transparent calc(var(--wood-plank-side-width) - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 3 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 3 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 3 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 3 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 5 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 5 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 5 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 5 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 7 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 7 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 7 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 7 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 9 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 9 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 9 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 9 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 11 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 11 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 11 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 11 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 13 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 13 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 13 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 13 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 15 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 15 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 15 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 15 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 17 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 17 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 17 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 17 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 19 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 19 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 19 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 19 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 21 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 21 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 21 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 21 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 23 - var(--wood-inset-length)),
          var(--wood-inset-dark) calc(var(--wood-plank-side-width) * 23 - var(--wood-inset-length)),
          var(--wood-inset-light) calc(var(--wood-plank-side-width) * 23 + var(--wood-inset-length)),
          transparent calc(var(--wood-plank-side-width) * 23 + var(--wood-inset-length))),
        /* side edges */
        linear-gradient(to right,
          var(--wood-edge-color) calc(var(--wood-plank-side-width) / 2.5),
          transparent calc(var(--wood-plank-side-width) / 2.5),
          transparent calc(100% - var(--wood-plank-side-width) / 2.5),
          var(--wood-edge-color) calc(100% - var(--wood-plank-side-width) / 2.5)),
        /* top edge */
        linear-gradient(to bottom,
          var(--wood-edge-color) var(--wood-plank-top-width),
          transparent var(--wood-plank-top-width)),
        /* bottom edge */
        linear-gradient(to top,
          var(--wood-edge-color) var(--wood-plank-bottom-width),
          transparent var(--wood-plank-bottom-width)),
        /* wood grain */
        repeating-linear-gradient(to right,
          var(--wood-grain),
          var(--wood-grain) 2px,
          transparent 2px,
          transparent 9px,
          var(--wood-grain) 9px,
          var(--wood-grain) 11px,
          transparent 11px,
          transparent 25px),
        /* wood grain 2 */
        repeating-linear-gradient(85deg,
          var(--wood-grain-minor),
          var(--wood-grain-minor) 2px,
          transparent 2px,
          transparent 20px,
          var(--wood-grain-minor) 20px,
          var(--wood-grain-minor) 22px,
          transparent 22px,
          transparent 50px),
        /* wood grain 3 */
        repeating-linear-gradient(-85deg,
          var(--wood-grain-minor),
          var(--wood-grain-minor) 2px,
          transparent 2px,
          transparent 5px,
          var(--wood-grain-minor) 5px,
          var(--wood-grain-minor) 7px,
          transparent 7px,
          transparent 100px),
        /* wood grain 4 (horizontal) */
        repeating-linear-gradient(to bottom,
          transparent 8%,
          var(--wood-color-light) 8%,
          var(--wood-color-light) calc(8% + 4px),
          transparent calc(8% + 4px),
          transparent 17%,
          var(--wood-color-light) 17%,
          var(--wood-color-light) calc(17% + 2px),
          transparent calc(17% + 2px),
          transparent 19%,
          var(--wood-color-light) 19%,
          var(--wood-color-light) calc(19% + 3px),
          transparent calc(19% + 3px),
          transparent 40%,
          var(--wood-color-light) 40%,
          var(--wood-color-light) calc(40% + 2px),
          transparent calc(40% + 2px),
          transparent 60%),
        /* side edges outline */
        linear-gradient(to right,
          transparent calc(var(--wood-plank-side-width) / 2.5),
          var(--wood-border-color) calc(var(--wood-plank-side-width) / 2.5),
          var(--wood-border-color) calc(var(--wood-plank-side-width) / 2.5 + 2px),
          transparent calc(var(--wood-plank-side-width) / 2.5 + 2px),
          transparent calc(100% - var(--wood-plank-side-width) / 2.5 - 2px),
          var(--wood-border-color) calc(100% - var(--wood-plank-side-width) / 2.5 - 2px)),
        /* top edge outline */
        linear-gradient(to bottom,
          var(--wood-border-color) calc(var(--wood-plank-top-width) + 3px),
          transparent calc(var(--wood-plank-top-width) + 3px)),
        /* bottom edge outline */
        linear-gradient(to top,
          var(--wood-border-color) calc(var(--wood-plank-bottom-width) + 2px),
          transparent calc(var(--wood-plank-bottom-width) + 2px)),
        /* planks */
        linear-gradient(to right,
          var(--wood-color-light) var(--wood-plank-side-width),
          var(--wood-color-dark) var(--wood-plank-side-width),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width)),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width)),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 2),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 2),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 3),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 3),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 4),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 4),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 5),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 5),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 6),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 6),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 7),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 7),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 8),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 8),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 9),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 9),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 10),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 10),
          var(--wood-color-dark) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 11),
          var(--wood-color-light) calc(var(--wood-plank-side-width) + var(--wood-plank-width) * 11));

      border: 2px solid black;
      border-radius: 0.4rem;
      padding: 150px calc(1% + 60px);
    }

    /* paper */
    #options::after {
      content: "";
      z-index: -1;
      position: absolute;
      top: 40px;
      left: 0px;
      right: 0px;
      bottom: 30px;
      width: 93%;
      margin: auto;

      background-image: linear-gradient(to right,
          var(--paper-border-color) var(--paper-border-width),
          transparent var(--paper-border-width)),
        linear-gradient(to left,
          var(--paper-border-color) var(--paper-border-width),
          transparent var(--paper-border-width)),
        linear-gradient(to bottom,
          var(--paper-border-color) var(--paper-border-width),
          transparent var(--paper-border-width)),
        linear-gradient(to top,
          var(--paper-border-color) var(--paper-border-width),
          transparent var(--paper-border-width)),
        radial-gradient(var(--paper-color) var(--paper-shadow-size), var(--paper-color-dark) var(--paper-shadow-size));

      border: 0px solid var(--paper-border-color);
      border-image: url("assets/kmtt-menu-combined-min.webp");
      border-image-slice: 151 206 123 206;
      border-image-width: 120px 170px 100px 170px;
      border-image-outset: 26px 5px 0px 5px;
      border-image-repeat: stretch stretch;
    }

    /* fork */
    .mb-2>label::before {
      content: "";
      background-image: url("assets/kmtt-option-label-fork-min.webp");
      background-size: contain;
      background-repeat: no-repeat;
      width: 30px;
      height: 40px;
      position: absolute;
      /* left: -8px; */
      /* bottom: 0; */
      left: 13px;
      transform: translate(-100%, 0);
    }

    /* option labels checker pattern */
    .mb-2>label {
      position: relative;
      color: var(--label-font-color);
      padding: 4px 16px;
      width: 100%;
      margin: 3% 0;
      text-align: center;
      border-image: url("assets/kmtt-option-label-pattern-min.webp");
      border-image-slice: 2 2 1 1 fill;
      border-image-width: 8px 8px 4px 4px;
      border-image-outset: 0px 0px 0px 0px;
      border-image-repeat: round round;
      image-rendering: pixelated;
    }

    .form-check {
      display: grid;
      grid-template-columns: 55% 1fr;
      align-items: center;
      padding-left: 0;
    }

    .form-check:hover {
      background-color: #ffdf94;
      border-radius: 0.5rem;
    }

    .form-check-label {
      order: 1;
    }

    .form-check-input[type="checkbox"] {
      order: 2;
      justify-self: center;
      appearance: none;
      width: 20px;
      height: 20px;
      background-color: var(--checkbox-inner-color);
      margin: 4px 0px 4px 8px;

      position: relative;
      box-shadow:
        /* left, right, top edges and corners*/
        -2px -2px 0 0 var(--checkbox-border-color),
        2px -2px 0 0 var(--checkbox-border-color),
        /* bottom edge and corners */
        0 4px 0 0 var(--checkbox-border-bottom-color),
        -2px 4px 0 0 var(--wood-color-light),
        2px 4px 0 0 var(--wood-color-light);
    }

    .form-check-input[type="checkbox"]:checked::after {
      content: "âœ”";
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--wood-color-dark);
      font-size: 35px;
      font-weight: bold;
    }

    /* sparkles */
    .form-check-input[type="checkbox"]::before {
      content: url("assets/kmtt-effect-sparkle.webp");
      position: absolute;
      top: calc(50% - 4px);
      left: 50%;
      transform: translate(-50%, -50%);
      width: 160px;
      height: 128px;
      display: block;
      pointer-events: none;
      z-index: 10;
      opacity: 0;
    }

    .form-check-input[type="checkbox"]:checked::before {
      animation: sparkle-checked 0.4s forwards;
    }

    .form-check-input[type="checkbox"]:not(:checked)::before {
      animation: sparkle-unchecked 0.4s forwards;
    }

    @keyframes sparkle-checked {

      0%,
      99% {
        opacity: 1;
      }

      100% {
        opacity: 0;
      }
    }

    @keyframes sparkle-unchecked {

      0%,
      99% {
        opacity: 1;
      }

      100% {
        opacity: 0;
      }
    }

    .form-text {
      order: 3;
      /* ensure the text always goes to newline no matter the window or text size */
      width: 100%;
    }

    .alert {
      color: var(--label-font-color);
      text-align: center;

      background-color: var(--box-background);
      background-size: var(--background-size);
      /* background: repeating-linear-gradient(to right, var(--splash-stripe-color1), var(--splash-stripe-color1) var(--splash-stripe-width), var(--splash-stripe-color2) var(--splash-stripe-width), var(--splash-stripe-color2) calc(var(--splash-stripe-width) * 2)); */
      background-image: repeating-linear-gradient(to right, var(--box-primary-color), var(--box-primary-color) var(--splash-stripe-width), var(--box-secondary-color) var(--splash-stripe-width), var(--box-secondary-color) calc(var(--splash-stripe-width) * 2));

      border: 2px solid var(--box-background);
      border-radius: 0.6rem;

      outline: 4px solid var(--box-very-out);
      outline-offset: 0rem;
    }

    .alert::before {
      content: "";
      position: absolute;

      top: 5px;
      left: 5px;
      right: 5px;
      bottom: 5px;

      border: 5px dashed var(--box-dashed);
      border-radius: 0.3rem;

      outline: 2px solid black;
      outline-offset: 0.5rem;
    }
  </style>
  <base href="C:\StarryShiliu\Software\Agent\data\scripts" />
</head>

<body>

  <div class="container p-3">
    <div class="row">
      <div class="col-md-12">
        <h2 id="title" class="text-center">Kemono Teatime</h2>
        <p id="description" class="text-center">Configure text output and which hooks are enabled.
          <br>Check Agent's console output to see each text's corresponding hook.
        </p>
        <div id="options">
          <div class="form-check mb-2"><input id="config_fancyOutput" class="form-check-input" type="checkbox"
              role="switch"><label class="form-check-label" for="config_fancyOutput">Fancy Portraits</label></div>
          <div class="form-check mb-2"><input id="config_singleSentence" class="form-check-input" type="checkbox"
              role="switch"><label class="form-check-label" for="config_singleSentence">Single Sentence</label></div>
          <div class="form-check mb-2"><input id="config_noCharacterNames" class="form-check-input" type="checkbox"
              role="switch"><label class="form-check-label" for="config_noCharacterNames">Character Names</label>
          </div>
          <div class="form-check mb-2"><input id="config_onlyDialogue" class="form-check-input" type="checkbox"
              role="switch"><label class="form-check-label" for="config_onlyDialogue">Only Dialogue</label></div>
          <div class="form-check mb-2"><input id="config_filterSeenText" class="form-check-input" type="checkbox"
              role="switch"><label class="form-check-label" for="config_filterSeenText">Filter Seen Text</label></div>
          <div class="form-check mb-2"><input id="config_debugLogs" class="form-check-input" type="checkbox"
              role="switch"><label class="form-check-label" for="config_debugLogs">Show Debug Logs</label></div>
        </div>
      </div>
    </div>
  </div>
  <small id="loaded"></small>
  <div id="info" class="alert alert-info mt-3" role="alert">Filter Seen Text updated!</div>
  <div id="warn" style="display: none" class="alert alert-warning mt-3" role="alert"></div>
  <div id="success" style="display: none" class="alert alert-success mt-3" role="alert"></div>
  <div id="error" style="display: none" class="alert alert-danger mt-3" role="alert"></div>
  <script>
    // Doesn't work :(
    // window.addEventListener('error', (e) => error('An error occured in the UI: ' + e.error));

    let storageEnabled = false;
    let storageKey = null;
    const titleElement = document.getElementById('title');
    const descElement = document.getElementById('description');
    const optionsElement = document.getElementById('options');
    const alertTimeouts = {};
    const alertElements = {
      info: document.getElementById('info'),
      error: document.getElementById('error'),
      warn: document.getElementById('warn'),
      success: document.getElementById('success'),
    };

    // handle configuration changes from the script
    rpc.on('changed', (id, value) => {
      if (setConfig(id, value)) {
        // no need to notify the script since this
        // came from the script.
        onChange({ id }, value, false);
      }
    });

    // handle incoming alerts
    rpc.on('alert', alert);

    function updateStorage(id, value) {
      if (!storageEnabled) {
        return;
      }

      const json = localStorage.getItem(storageKey) || '{}';
      const config = JSON.parse(json);
      config[id] = value;
      localStorage.setItem(storageKey, JSON.stringify(config));
    }

    function loadStorage() {
      if (!storageEnabled) {
        return;
      }

      const json = localStorage.getItem(storageKey) || '{}';
      const config = JSON.parse(json);
      for (const key of Object.keys(config)) {
        if (setConfig(key, config[key])) {
          // notify the script
          onChange({ id: key }, config[key], true, false);
        }
      }
    }

    // unused but this function can be used to load an external CSS file
    function addStyle(file) {
      const link = document.createElement('link');
      link.href = window.location.href.replace('resources/app/dist/index.html', 'data/scripts/' + file);
      link.rel = 'stylesheet';
      // use prepend so the stylesheet is above our styles
      document.head.prepend(link);
    }

    function onChange(option, value, notify = true, showAlert = true) {
      if (!option.ephemeral) {
        updateStorage(option.id, value);
      }
      if (!notify) {
        return;
      }

      rpc.exports.changed(option.id, value).then(() => {
        if (!showAlert) return;
        const text = (option.label || option.id) + " updated!";
        alert('info', text, 1000);
      });
    }

    function setConfig(id, value) {
      if (id === undefined) {
        return false;
      }

      const element = document.getElementById('config_' + id);
      if (element === undefined) {
        error('Could not find element with ID ' + id);
        return false;
      }

      const tag = element.tagName.toLowerCase();

      // handle buttons
      if (tag === 'button') {
        // do nothing
        return false;
      }

      // handle checkboxes, numbers, and text
      if (tag === 'input') {
        switch (element.type) {
          case 'checkbox':
            element.checked = value;
            return true;
          case 'number':
          case 'text':
            element.value = value;
            return true;
          default:
            error('Could not handle update for ' + tag + ' with type ' + element.type + '!');
        }
        return false;
      }

      // handle selects
      if (tag === 'select') {
        const options = element.getElementsByTagName('option');
        for (const option of options) {
          const multiple = typeof value !== 'string';
          option.selected = multiple ? value.includes(option.value) : (option.value === value);
        }
        return true;
      }

      // unsupported element
      error('Could not handle update for tag ' + tag + '!');
      return false;
    }

    function addHelp(element, option) {
      if (!option.help) {
        return;
      }

      // don't add help text for inline checkboxes
      if (option.type === 'checkbox' && option.inline === true) {
        return;
      }

      const help = document.createElement('small');
      help.className = 'form-text text-muted';
      help.innerHTML = option.help;
      element.append(help);
    }

    function addOption(element, option) {
      const div = document.createElement('div');
      div.className = 'form-group mb-2';
      const label = document.createElement('label');
      label.innerText = option.label;
      label.htmlFor = element.id;
      div.append(label);
      div.append(element);
      addHelp(div, option);
      optionsElement.append(div);
    }

    function addTextField(option) {
      const input = document.createElement('input');
      input.id = 'config_' + option.id;
      input.className = 'form-control';
      input.readOnly = option.readOnly === true;
      if (option.type === 'number') {
        input.type = 'number';
        input.value = option.defaultValue || 0;
        input.onchange = (e) => onChange(option, parseInt(e.target.value));
      } else if (option.type === 'text') {
        input.type = 'text';
        input.value = option.defaultValue || '';
        input.onchange = (e) => onChange(option, e.target.value);
      } else {
        error('Unknown input type: ' + option.type);
        return;
      }
      addOption(input, option);
    }

    function addSelect(option) {
      const select = document.createElement('select');
      select.id = 'config_' + option.id;
      select.className = 'custom-select';
      select.onchange = function () {
        const selected = option.multiple ? [...this.selectedOptions].map(o => o.value) : this.value;
        onChange(option, selected);
      };

      if (option.multiple === true) {
        select.setAttribute('multiple', 'multiple');
      }

      // add the options
      for (const opt of option.options) {
        const element = document.createElement('option');
        element.value = opt.value;
        element.innerText = opt.text;
        element.selected = (opt.value === option.defaultValue) || (option.multiple && opt.selected);
        select.appendChild(element);
      }

      addOption(select, option);
    }

    function addCheckbox(option) {
      const div = document.createElement('div');
      div.className = 'form-check mb-2';

      const input = document.createElement('input');
      input.id = 'config_' + option.id;
      input.className = 'form-check-input';
      input.type = 'checkbox';
      input.role = 'switch';
      input.checked = option.defaultValue || false;
      input.onchange = (e) => onChange(option, e.currentTarget.checked);

      const label = document.createElement('label');
      label.className = 'form-check-label';
      label.innerText = option.label;
      label.htmlFor = input.id;

      div.appendChild(input);
      div.appendChild(label);
      addHelp(div, option);
      optionsElement.appendChild(div);
    }

    function addButton(option) {
      const button = document.createElement('button');
      button.type = "button";
      button.id = 'config_' + option.id;
      button.className = 'btn btn-success btn-block mt-2'; // success to match Agent's button
      button.innerText = option.label;
      button.onclick = () => onChange(option, undefined);

      optionsElement.appendChild(button);
    }

    // display an error in the UI
    function error(message) { alert('error', message); }

    // display an alert in the UI (info, warn, error)
    function alert(type, message, duration = 5000) {
      if (message === undefined) return;
      const element = alertElements[type];
      if (element === undefined) return;

      element.innerText = message;
      element.style.display = '';
      clearTimeout(alertTimeouts[type]);
      alertTimeouts[type] = setTimeout(() => element.style.display = 'none', duration);
    }

    function loaded() {
      document.getElementById("loading").remove();
    }

    // call script to get title, description, and configuration
    rpc.exports.title().then(title => titleElement.innerHTML = title);
    rpc.exports.description().then(desc => descElement.innerHTML = desc);
    rpc.exports.options().then(options => {
      for (const option of options) {
        switch (option.type) {
          case 'select':
            addSelect(option);
            break;
          case 'checkbox':
            addCheckbox(option);
            break;
          case 'number':
          case 'text':
            addTextField(option);
            break;
          case 'button':
            addButton(option);
            break;
          default:
            error('No handler for "' + option.type + '" option type!');
        }
      }

      loaded();

      rpc.exports.storage().then(storage => {
        if (!storage.enabled) return;

        storageKey = 'config-' + storage.key;
        storageEnabled = true;
        console.log('Enabling storage with key ' + storageKey + '...');
        loadStorage();
      });
    })

    addStyle('../../resources/app/dist/bundle.css');
  </script>


</body>

</html>